# =============================================================================
# Flyway Migrations Pipeline - Simplified Single Target Deployment
# =============================================================================
# Based on Flyway AutoPilot, streamlined for single target deployment
#
# Prerequisites:
# 1. Variable group 'RG_Auth' with RG_EMAIL and RG_TOKEN
# 2. Databases: build, check, target (all on localhost)
# =============================================================================

trigger: none

pool:
  name: default

variables:
  - group: RG_Auth

stages:

  # ===========================================================================
  # Stage 1: Build - Validate migrations compile successfully
  # ===========================================================================
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: Build
        displayName: 'Validate Migrations'
        steps:
          - script: flyway auth -IAgreeToTheEula -email="$(RG_EMAIL)" -token="$(RG_TOKEN)"
            displayName: 'Flyway Auth'

          - script: flyway clean migrate info -environment=build "-environments.build.provisioner=clean"
            displayName: 'Clean, Migrate, Info (Build)'
            env:
              FLYWAY_CLEAN_DISABLED: false

  # ===========================================================================
  # Stage 2: Check - Generate deployment report for target
  # ===========================================================================
  - stage: Check
    displayName: 'Check'
    dependsOn: Build
    jobs:
      - job: Check
        displayName: 'Generate Report'
        steps:
          - script: |
              if not exist reports mkdir reports
            displayName: 'Create Reports Folder'

          - script: flyway check -changes -drift -dryrun -environment=mydeploymenttarget -check.buildEnvironment=check -reportFilename="reports\report.html"
            displayName: 'Flyway Check (Changes, Drift, DryRun)'
            env:
              FLYWAY_CLEAN_DISABLED: false

          - task: PublishBuildArtifacts@1
            displayName: 'Publish Report'
            inputs:
              PathtoPublish: 'reports'
              ArtifactName: 'Reports'

  # ===========================================================================
  # Stage 3: Deploy - Apply migrations to target (with approval)
  # ===========================================================================
  - stage: Deploy
    displayName: 'Deploy'
    dependsOn: Check
    jobs:
      - job: Approve
        displayName: 'Approval Gate'
        pool: server
        steps:
          - task: ManualValidation@0
            displayName: 'Approve Deployment'
            inputs:
              instructions: 'Review the Check report artifact before approving deployment to MyDeploymentTarget.'

      - job: Deploy
        displayName: 'Migrate'
        dependsOn: Approve
        steps:
          - script: flyway info migrate info -environment=mydeploymenttarget
            displayName: 'Flyway Migrate (Target)'
